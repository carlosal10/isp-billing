<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ISP Billing</title>
    <link rel="stylesheet" href="css/Style.css">
    <link rel="stylesheet" href="css/plans.css">
    <link rel="stylesheet" href="css/customer.css">
    <link rel="stylesheet" href="css/connect.css">
    <link rel="stylesheet" href="css/usage.css">
    <link rel="icon" type="image/png" sizes="32x32" href="isp-billing\favicon-32x32.png">
</head>
<body>
       <!-- Hamburger Menu (visible on mobile only) -->
<div class="hamburger" onclick="toggleSidebar()">
    ☰
</div>
<div><button id="desktopSidebarToggle" class="sidebar-toggle">☰ MENU</button>
</div>
<!-- Sidebar -->
<div id="sidebar" class="sidebar">
    <div class="sidebar-header">
        <h2>ISP Billing</h2>
        <span class="close-btn" onclick="toggleSidebar()"></span>
    </div>
    <ul>
        <li><a href="Dashpanel.html">Dashboard</a></li>
        <li><button id="customerBtn" class="sidebar-btn">Clients</button></li>
        <li><button id="planBtn" class="sidebar-btn">Subscription Plans</button></li>
        <li><button id="pppoeBtn" class="sidebar-btn">PPPoE Users</button></li>
        <li><a href="#">Invoices</a></li>
        <li><a href="#">Payments</a></li>
        <li><a href="Payment.html">Payment Link</a></li>
        <li><button id="connectBtn" class="sidebar-btn">Connect To Mikrotik</button></li>
        <li><button id="usageBtn" class="sidebar-btn">Usage Logs</button></li>
        <li><a href="logout.php"><button type="button">Logout</button></a></li>
    </ul>
</div>


    <div class="main-content">
        <h1>Welcome</h1>
        <div class="stats">
            <div class="card">Total Clients: <span id="totalCustomers">0</span></div>
            <div class="card">Active Plans: <span id="activePlans">0</span></div>
            <div class="card">Pending Invoices: <span id="pendingInvoices">0</span></div>
        </div>
        <div class="pppoe-status-section">
    <h2>Online PPPoE Users</h2>
    <table id="onlinePppoeTable">
        <thead>
            <tr>
                <th>Username</th>
                <th>IP Address</th>
                <th>Uptime</th>
                <th>Bytes In</th>
                <th>Bytes Out</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    </div>
        <!-- Toggle and Stats Section -->
<div class="pppoe-usage-controls">
    <label>
        <input type="checkbox" id="showExpiredToggle">
        Show Expired/Disabled Users
    </label>
</div>

<!-- Usage Stats Section -->
<div class="pppoe-usage-stats">
    <h2>Usage Summary</h2>
    <div class="usage-box">
        <div>Total Bytes In: <span id="totalBytesIn">0</span></div>
        <div>Total Bytes Out: <span id="totalBytesOut">0</span></div>
    </div>
</div>

<!-- Chart Placeholder -->
<canvas id="pppoeChart" width="100%" height="60"></canvas>


    </div>
    <div id="pppoeModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Manage PPPoE Users</h2>

    <!-- Add User Form -->
    <!-- PPPoE Add User Form -->
<form id="addUserForm">
    <input type="text" id="pppoeUsername" placeholder="Username" required>
    <input type="password" id="pppoePassword" placeholder="Password" required>
    <select id="profile" required>
    <option value="">Loading profiles...</option>
</select>

    <button type="submit">Add User</button>
</form>


    <!-- Update User Password -->
    <form id="updateUserForm">
      <input type="text" id="updateUsername" placeholder="Username" required>
      <input type="password" id="newPassword" placeholder="New Password" required>
      <button type="submit">Update Password</button>
    </form>

    <!-- Remove User -->
    <form id="removeUserForm">
      <input type="text" id="removeUsername" placeholder="Username" required>
      <button type="submit">Remove User</button>
    </form>
  </div>
</div>

<!-- Add Plan Modal -->
<div id="addPlanModal" class="addPlan-modal">
  <div class="addPlanmodal-content">
    <span class="close" id="closePlanForm">&times;</span>
    <h2>Add</h2>
    <!-- Add Plan Form -->
        <button id="addPlanButton">Click to Add</button>
        <div id="addPlanForm" style="display: none;">
            <button id="closePlanForm">X</button>
            <h2>Add Plan</h2>
            <form id="planForm">
                <input type="text" id="planName" placeholder="Plan Name" required>
                <input type="text" id="planDescription" placeholder="Description" required>
                <input type="number" id="planPrice" placeholder="Price" required>
                <input type="text" id="planDuration" placeholder="Duration (e.g., monthly)" required>
                
                <button type="submit">Save</button>
            </form>
        </div>
    </div>

    <div class="table-container">
        <!-- Plans Table -->
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Price</th>
                    <th>Duration</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="plansTable"></tbody>
        </table>
    </div>
</div>
<!-- Add Customer Modal -->
<div id="addCustomerModal" class="AddCustomer-modal">
  <div class="addCustomermodal-content">
    <span class="close" id="closeCustomerForm">&times;</span>
    <h2>Add Clients</h2>
     <!-- Add Customer Section -->
    <div class="container">
        <button id="addCustomerButton">Click to Add</button>
        <div id="formOverlay" style="display: none;"></div> <!-- Overlay for popup form -->
        
        <!-- Add Customer Form -->
        <div id="addCustomerForm" style="display: none;">
            <button id="closeForm">X</button>
            <h2>Add Customer</h2>
            <form id="customerForm">
                <input type="text" id="name" placeholder="Name" required>
                <input type="email" id="email" placeholder="Email" required>
                <input type="text" id="phone" placeholder="Phone" required>
                <input type="text" id="address" placeholder="Address">
                
                <!-- Auto-generated Account Number -->
                <input type="text" id="accountNumber" placeholder="Account Number" readonly>
                
                <!-- Plan Dropdown -->
                <label>Select Plan:</label>
                <select id="plan" required>
                    <option value="">-- Select Plan --</option>
                </select>
                
                <input type="text" id="routerIp" placeholder="Router IP (Optional)">
                <button type="submit">Save</button>
            </form>
        </div>
    </div>

    <!-- Customers Table -->
    <div class="table-container">    
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Address</th>
                    <th>Account Number</th>
                    <th>Plan</th>
                    <th>Router IP</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="customersTable"></tbody>
        </table>
    </div>
  </div>
    <!-- Connect to mikrotik modal -->
</div>
    <div id="connectModal" class="connect-modal">
        <div class="modal-content">
            <span class="close" id="closeConnectForm">&times;</span>
            <h2>Connect To Mikrotik</h2>
  <form id="connectForm" autocomplete="on">
    <label for="ip">Router IP:</label>
    <input type="text" id="ip" required />

    <label for="username">Username:</label>
    <input type="text" id="username" required />

    <label for="password">Password:</label>
    <input type="password" id="password" required />

    <button type="submit" id="submitBtn">Connect</button>
  </form>

  <div id="loading"></div>
  <div id="response"></div>
<div id="usageModal" class="usage-modal">
        <div class="modal-content">
            <span class="close" id="usageClose">&times;</span>
            <h2>Logs</h2>
            <!-- Graphs Section -->
            <section class="dashboard-section">
                  <h2>PPPoE Usage Trends</h2>
                  <canvas id="usageTrendsChart" height="100"></canvas>
            </section>

            <section class="dashboard-section">
              <h2>Active PPPoE Users (Daily)</h2>
              <canvas id="activeUsersChart" height="100"></canvas>
            </section>

        <!-- Reports Section -->
            <section class="dashboard-section">
              <h2>Reports</h2>
              <div class="reports-buttons">
                <button id="downloadUsageReport">Download Usage Report</button>
                <button id="downloadInvoiceReport">Download Invoice Report</button>
              </div>
            </section>
            <section id="graphSection">
              <h2>Usage Analytics</h2>

                  <div class="chart-card">
                    <h3>Daily Active Users</h3>
                        <canvas id="activeUsersChart"></canvas>
                  </div>

                  <div class="chart-card">
                        <h3>Daily Usage Trends</h3>
                            <canvas id="usageTrendsChart"></canvas>
                  </div>
            </section>
            <section id="reportsSection">
              <h2>Reports</h2>

                  <div class="report-card">
                    <h3>Invoices</h3>
                    <table id="invoiceTable">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>Customer</th>
                          <th>Amount</th>
                          <th>Date</th>
                          <th>Download</th>
                        </tr>
                         </thead>
                          <tbody></tbody>
                        </table>
                  </div>

                  <div class="report-card">
                <h3>Usage Logs</h3>
                    <table id="usageLogsTable">
              <thead>
                    <tr>
                          <th>#</th>
                          <th>User</th>
                          <th>Date</th>
                          <th>Bytes In</th>
                          <th>Bytes Out</th>
                    </tr>
              </thead>
              <tbody></tbody>
                </table>
                  </div>
                </section>


        </div>
    <canvas id="activeUsersChart"></canvas>
<canvas id="usageTrendsChart"></canvas>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('connectForm');
      const responseDiv = document.getElementById('response');
      const loadingDiv = document.getElementById('loading');
      const submitBtn = document.getElementById('submitBtn');

      form.addEventListener('submit', async function (e) {
        e.preventDefault(); // Prevent default form submission

        const ip = document.getElementById('ip').value.trim();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        if (!ip || !username || !password) {
          responseDiv.textContent = 'All fields are required.';
          return;
        }

        loadingDiv.textContent = 'Connecting...';
        responseDiv.textContent = '';
        submitBtn.disabled = true;

        try {
          const res = await fetch('https://isp-billing-uq58.onrender.com/api/connect', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ip, username, password })
          });

          const data = await res.json();
          if (data.success) {
            responseDiv.textContent = `✅ ${data.message}`;
          } else {
            responseDiv.textContent = `❌ ${data.message || 'Connection failed'}`;
          }
        } catch (err) {
          responseDiv.textContent = '🚫 Network or server error.';
        } finally {
          loadingDiv.textContent = '';
          submitBtn.disabled = false;
        }
      });
    });
  </script>
    <script>
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('show');
    }

    // Close sidebar when clicking outside of it
    document.addEventListener('click', function (e) {
        const sidebar = document.getElementById('sidebar');
        const hamburger = document.querySelector('.hamburger');

        // If sidebar is open and click is outside sidebar and hamburger
        if (
            sidebar.classList.contains('show') &&
            !sidebar.contains(e.target) &&
            !hamburger.contains(e.target)
        ) {
            sidebar.classList.remove('show');
        }
    });

    function handleResize() {
  if (window.innerWidth > 768) {
    // Desktop: show sidebar always
    sidebar.classList.add('show');
  } else {
    // Mobile: hide by default
    sidebar.classList.remove('show');
  }
}
const desktopSidebarToggle = document.getElementById("desktopSidebarToggle");

        desktopSidebarToggle.addEventListener("click", function (e) {
        e.stopPropagation(); // Prevent triggering outside click
        sidebar.classList.toggle("show");
     });

window.addEventListener('resize', handleResize);

// Run once on load to set correct state
handleResize();
document.getElementById('downloadUsageReport')?.addEventListener('click', () => {
  window.open(`${baseApi}/reports/usage`, '_blank');
});

document.getElementById('downloadInvoiceReport')?.addEventListener('click', () => {
  window.open(`${baseApi}/reports/invoices`, '_blank');
});

</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="js/Customer.js"></script>
    <script src="js/Plans.js"></script>
    <script src="js/Script.js"></script>
    <script src="js/connect.js"></script>
</body>
</html>
